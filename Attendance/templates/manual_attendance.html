{% extends "base.html" %}

{% block title %}Manual Attendance - Nipe Attendance{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold mb-4">Manual <span class="gradient-text">Attendance</span></h1>
        <p class="text-slate-400">Mark attendance for each student below.</p>
    </div>

    <style>
        .checkbox-wrapper {
            --checkbox-size: 25px;
            --checkbox-color: #00ff88;
            --checkbox-shadow: rgba(0, 255, 136, 0.3);
            --checkbox-border: rgba(0, 255, 136, 0.7);
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            padding: 10px;
        }

        .checkbox-wrapper input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkbox-wrapper .checkmark {
            position: relative;
            width: var(--checkbox-size);
            height: var(--checkbox-size);
            border: 2px solid var(--checkbox-border);
            border-radius: 8px;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 15px var(--checkbox-shadow);
            overflow: hidden;
        }

        .checkbox-wrapper .checkmark::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--checkbox-color), #00ffcc);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: scale(0) rotate(-45deg);
        }

        .checkbox-wrapper input:checked~.checkmark::before {
            opacity: 1;
            transform: scale(1) rotate(0);
        }

        .checkbox-wrapper .checkmark svg {
            width: 0;
            height: 0;
            color: #1a1a1a;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }

        .checkbox-wrapper input:checked~.checkmark svg {
            width: 18px;
            height: 18px;
            transform: rotate(360deg);
        }

        .checkbox-wrapper:hover .checkmark {
            border-color: var(--checkbox-color);
            transform: scale(1.1);
            box-shadow:
                0 0 20px var(--checkbox-shadow),
                0 0 40px var(--checkbox-shadow),
                inset 0 0 10px var(--checkbox-shadow);
        }

        .checkbox-wrapper input:checked~.checkmark {
            animation: pulse 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px var(--checkbox-shadow);
            }

            50% {
                transform: scale(0.9);
                box-shadow:
                    0 0 30px var(--checkbox-shadow),
                    0 0 50px var(--checkbox-shadow);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 20px var(--checkbox-shadow);
            }
        }

        .checkbox-wrapper .label {
            margin-left: 15px;
            font-family: "Segoe UI", sans-serif;
            color: var(--checkbox-color);
            font-size: 18px;
            text-shadow: 0 0 10px var(--checkbox-shadow);
            opacity: 0.9;
            transition: all 0.3s;
        }

        .checkbox-wrapper:hover .label {
            opacity: 1;
            transform: translateX(5px);
        }

        /* Glowing dots animation */
        .checkbox-wrapper::after,
        .checkbox-wrapper::before {
            content: "";
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--checkbox-color);
            opacity: 0;
            transition: all 0.5s;
        }

        .checkbox-wrapper::before {
            left: -10px;
            top: 50%;
        }

        .checkbox-wrapper::after {
            right: -10px;
            top: 50%;
        }

        .checkbox-wrapper:hover::before {
            opacity: 1;
            transform: translateX(-10px);
            box-shadow: 0 0 10px var(--checkbox-color);
        }

        .checkbox-wrapper:hover::after {
            opacity: 1;
            transform: translateX(10px);
            box-shadow: 0 0 10px var(--checkbox-color);
        }
    </style>

    <div class="glass-panel rounded-2xl p-8 shadow-2xl">
        <form action="/manual" method="post" id="manual-attendance-form">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse" id="manual-attendance-table">
                    <thead>
                        <tr class="border-b border-slate-700">
                            <th class="py-4 px-6 text-sm font-semibold text-slate-300 uppercase tracking-wider cursor-pointer hover:text-white transition-colors"
                                onclick="sortTable(0, 'manual-attendance-table')">
                                Student Name <i class="fas fa-sort ml-1 text-xs opacity-50"></i>
                            </th>
                            <th class="py-4 px-6 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center cursor-pointer hover:text-white transition-colors"
                                onclick="sortTable(1, 'manual-attendance-table')">
                                Status <i class="fas fa-sort ml-1 text-xs opacity-50"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700/50">
                        {% for student in students %}
                        <tr class="hover:bg-slate-800/50 transition-colors">
                            <td class="py-4 px-6 font-medium text-white">{{ student.name }}</td>
                            <td class="py-4 px-6 text-center flex justify-center">
                                <label class="checkbox-wrapper">
                                    <input type="hidden" name="status_{{ student.id }}" value="Absent">
                                    <input type="checkbox" name="status_{{ student.id }}" value="Present" checked
                                        onchange="updateStatusLabel(this, '{{ student.id }}')">
                                    <div class="checkmark">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M20 6L9 17L4 12" stroke-width="3" stroke-linecap="round"
                                                stroke-linejoin="round"></path>
                                        </svg>
                                    </div>
                                    <span id="status-label-{{ student.id }}" class="label">Present</span>
                                </label>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" id="export-manual-btn"
                    class="px-6 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-colors border border-slate-600">
                    <i class="fas fa-file-export mr-2"></i> Save & Export
                </button>
                <button type="submit"
                    class="px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-medium transition-colors shadow-lg shadow-indigo-500/25">
                    <i class="fas fa-save mr-2"></i> Submit Attendance
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateStatusLabel(checkbox, studentId) {
        const label = document.getElementById(`status-label-${studentId}`);
        const wrapper = checkbox.closest('.checkbox-wrapper');

        if (checkbox.checked) {
            label.textContent = "Present";
            wrapper.style.setProperty('--checkbox-color', '#00ff88'); // Green
            wrapper.style.setProperty('--checkbox-shadow', 'rgba(0, 255, 136, 0.3)');
            wrapper.style.setProperty('--checkbox-border', 'rgba(0, 255, 136, 0.7)');
        } else {
            label.textContent = "Absent";
            wrapper.style.setProperty('--checkbox-color', '#ff4d4d'); // Red
            wrapper.style.setProperty('--checkbox-shadow', 'rgba(255, 77, 77, 0.3)');
            wrapper.style.setProperty('--checkbox-border', 'rgba(255, 77, 77, 0.7)');
        }
    }

    document.getElementById('export-manual-btn').addEventListener('click', async () => {
        const form = document.querySelector('#manual-attendance-form');
        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await response.json();

            if (data.success) {
                // Show a nice toast or alert (using standard alert for now, could be improved)
                alert(data.message + " Now downloading report.");
                window.location.href = '/download_report';
            } else {
                alert("Error saving attendance: " + data.message);
            }
        } catch (error) {
            console.error('Error during save and export:', error);
            alert('An error occurred while trying to save and export attendance.');
        }
    });
</script>
{% endblock %}