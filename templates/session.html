{% extends "base.html" %}
{% block body %}
<div class="text-center mb-3">
  <h2>Attendance Portal</h2>
</div>

<div class="row">
  <div class="col-md-5">
    <div class="card p-3 mb-3">
      <h4>Present Count : <span id="presentCount">{{ s.present|length }}</span></h4>
      <ul id="presentList" class="list-group mb-3">
        {% for pid in s.present %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ pid }}
            <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove();updateCount();">ðŸ—‘</button>
          </li>
        {% endfor %}
      </ul>
      <div>
        <input id="manualStudent" class="form-control" placeholder="Student name / id">
        <button id="addManual" class="btn btn-primary mt-2">+ Add Manually</button>
      </div>
    </div>
  </div>

  <div class="col-md-7">
    <div class="card p-3 text-center">
      <h5>Connect to College Wi-Fi and Scan the QR Code to Mark Attendance</h5>
      <img id="qr" width="320" height="320" alt="QR">
      <p class="mt-2"><small>QR rotates every {{ s.lifetime }}s</small></p>
      <div class="mt-2">
        <small>Session id: <strong id="sessionId">{{ s.session_id }}</strong></small>
      </div>
    </div>
  </div>
</div>

<script>
const sessionId = "{{ s.session_id }}";
const tokenCount = {{ s.tokens|length }};
const lifetime = {{ s.lifetime }} * 1000;
let idx = 0;

const socket = io();
socket.on('connect', () => socket.emit('join', {session_id: sessionId}));

socket.on('present_update', data => {
  if (data.session_id !== sessionId) return;
  addPresent(data.student_id);
});
socket.on('scan_pending', data => {
  // optional UI for partial scans
});

function show(i){
  document.getElementById('qr').src = `/qr/${sessionId}/${i}.png?ts=${Date.now()}`;
}
show(0);
const iv = setInterval(() => {
  idx++;
  if (idx >= tokenCount) { clearInterval(iv); return; }
  show(idx);
}, lifetime);

// manual add
document.getElementById('addManual').onclick = async () => {
  const name = document.getElementById('manualStudent').value.trim();
  if(!name) return alert('Enter student id/name');
  const r = await fetch('/teacher/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({session_id: sessionId, student_id: name})
  });
  const j = await r.json();
  if (j.ok) addPresent(name);
};

function addPresent(name){
  const ul = document.getElementById('presentList');
  // skip duplicates
  if ([...ul.querySelectorAll('li')].some(li => li.firstChild.nodeValue.trim() === name)) return;
  const li = document.createElement('li');
  li.className = 'list-group-item d-flex justify-content-between align-items-center';
  li.innerHTML = `${name}<button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove();updateCount();">ðŸ—‘</button>`;
  ul.appendChild(li);
  updateCount();
}
function updateCount(){
  document.getElementById('presentCount').innerText = document.querySelectorAll('#presentList li').length;
}
</script>
{% endblock %}
